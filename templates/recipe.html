{% extends "base.html" %}
{% block title %}
{{ recipe['title'] }} - Fork.it
{% endblock %}
{% block content %}
{% if username %}
<div class="options right">
    {% if username == recipe['username'] or username == 'Admin' %}
    <a href="{{ url_for('edit_recipe', urn=recipe['urn']) }}" class="btn-floating btn-large waves-effect waves-light tooltipped" data-position="left" data-tooltip="Edit recipe"><i class="material-icons">mode_edit</i></a>
    {% if username == 'Admin' %}
    <a href="{{ url_for('feature_recipe', urn=recipe['urn']) }}" class="btn-floating btn-large waves-effect waves-light tooltipped" data-position="left" data-tooltip="Feature recipe" id="feature-btn">
        {% if recipe['featured'] %}
        <i class="material-icons">star</i>
        {% else %}
        <i class="material-icons">star_border</i>
        {% endif %}
    </a>
    {% endif %}
    {% else %}
    <a href="{{ url_for('favourite_recipe', urn=recipe['urn']) }}" class="btn-floating btn-large waves-effect waves-light tooltipped" data-position="left" data-tooltip="Favourite recipe" id="fav-btn">
        {% if favourite %}
        <i class="material-icons">favorite</i>
        {% else %}
        <i class="material-icons">favorite_border</i>
        {% endif %}
    </a>
    {% endif %}
</div>
{% endif %}
<article>
    <div class="container recipe-header">
        <h1>{{ recipe['title'] }}</h1>
    </div>
    {% if recipe['image'] %}
    <div class="container-m">
        <img src="{{ recipe['image'] }}" alt="{{ recipe['title'] }}" class="responsive-img">
    </div>
    {% endif %}
    <div class="container">
        <div class="row">
            <div class="col s12">
                By <a href="{{ url_for('recipes', username=recipe['username']) }}">{{ recipe['username'] }}</a> on {{ recipe['date'] }}.
                {% if recipe['parent-title'] %}
                It's a fork of <a href="{{ url_for('recipe', urn=recipe['parent']) }}">{{ parent_title }}</a>
                {% if recipe['forks'] %}
                and has <a href="{{ url_for('recipes', forks=urn) }}">{{ recipe['forks'] }} forks</a> of it's own.
                {% endif %}
                {% else %}
                {% if recipe['forks'] %}
                It has <a href="{{ url_for('recipes', forks=urn) }}">{{ recipe['forks'] }} forks</a>.
                {% endif %}
                {% endif %}
                
                <i class="material-icons small">access_time</i> Prep-Time: {{ recipe['prep-time'] }}
                <i class="material-icons small">access_time</i> Cooking-Time: {{ recipe['cook-time'] }}
                {% if recipe['meals'] %}
            </div>
            <div class="col s12 m6">
                {% for meal in recipe['meals'] %}
                <div class="chip"><a href="{{ url_for('recipes', meals=meal) }}">{{meal}}</a></div>
                {% endfor %}
                {% endif %}
            </div>
        </div>
        <div class="row">
            <div class="col s12">
                <div class="ingredients">
                    <table class="striped">
                        <thead>
                            <tr>
                                <td>
                                    <h2>Ingredients</h2>
                                </td>
                            </tr>
                        </thead>
                        <tbody class="flow-text">
                            {% for ingredient in recipe['ingredients'] %}
                            <tr>
                                <td>{{ ingredient }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <h2 class="method-header">Method</h2>
                <ol class="method">
                    {% for method in recipe['methods'] %}
                    <li class="flow-text">{{ method }}</li>
                    {% endfor %}
                </ol>
            </div>
        </div>
        <div class="row tags">
            {% if recipe['tags'] %}
            <div class="col s12">
                <h3>Tags</h3>
                {% for tag in recipe['tags'] %}
                <div class="chip"><a href="{{ url_for('recipes', tags=tag) }}">{{tag}}</a></div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% if username %}
        <div class="row">
            <a href="{{ url_for('add_recipe', fork=recipe['urn']) }}" class="waves-effect waves-light btn">Fork this recipe</a>
        </div>
        {% endif %}
        <div class="divider"></div>
        <div class="row">
            <div class="col s12" id='comments'>
                <h4>Comments</h4>
                {% if recipe['comment-count'] %}
                <p id="comment-count">{{ recipe['comment-count'] }} comments.</p>
                <div id="comments-content">
                {% for comment in recipe['comments'] %}
                    <div class="divider"></div>
                    <p>By {{ comment['username'] }} at {{ comment['time'] }}</p>
                    <blockquote>
                    {% set lines = comment['comment'].split('\n') %}
                    {% for line in lines %}
                        <p>{{ line }}</p>
                    {% endfor %}
                    </blockquote>
                    {% if username == 'Admin' or username == comment['username'] %}
                    <form action="{{ url_for('delete_comment', urn=urn) }}" method="POST" class="delete-comment">
                        <input type="hidden" name="comment-index" value="{{ loop.index - 1 }}">
                        <div class="delete-wrapper">
                            <button class="btn waves-effect waves-light red small right" type="submit"><i class="material-icons left">delete</i>Delete Comment</button>
                        </div>
                    </form>
                    {% endif %}
                {% endfor %}
                    <div class="divider"></div>
                </div>
                {% else %}
                <p id="comment-count">No comments. Be the first to comment on this recipe.</p>
                <div id="comments-content"></div>
                {% endif %}
                <p></p>
            </div>
        
            {% if username %}
            <form action="{{ url_for('comments', urn=recipe['urn']) }}" method="POST" id='add-comment'>
                <div class="col s12">
                    <p>Commenting as {{username}}</p>
                </div>
                <div class="input-field col s12">
                      <textarea id="comment" name="comment" class="materialize-textarea validate" required></textarea>
                      <label for="comment">Comment</label>
                      <span class="helper-text" data-error="Please enter a comment!"></span>
                </div>
                <div class="col s12">
                    <button class="btn waves-effect waves-light" type="submit" name="action">Post Comment</button>
                </div>
            </form>
            {% else %}
            <div class="col s12">
                <p><a class="modal-trigger" href="#login-modal">Log in</a> to comment on this recipe.</p>
            </div>
            {% endif %}
        </div>
    </div>
</article>
{% endblock %}
{% block javascript %}
<script>
    const $ = cash;

    function jsonGet(url, callback) {
        let xhr = new XMLHttpRequest();

        xhr.open("GET", url, true); //Filter by postcodes, lat and lng as these are the only things we need
        xhr.setRequestHeader("Content-Type", "application/json");

        xhr.onreadystatechange = callback;

        xhr.send(); 
    }

    function jsonPost(url, data, callback) {
        let xhr = new XMLHttpRequest();

        xhr.open("POST", url, true); //Filter by postcodes, lat and lng as these are the only things we need
        xhr.setRequestHeader("Content-Type", "application/json");

        xhr.onreadystatechange = callback;

        xhr.send(JSON.stringify(data));
    }

    function deleteComment() {
        if (this.readyState == 4) {
            if (this.status == 200) {
                let response = JSON.parse(this.responseText);
                if (response.success === true) {
                    jsonGet('{{url_for("comments", urn=urn)}}', reloadComments);
                }
                response.messages.forEach(function(message) {
                    M.toast({ html: message });
                });
            }else M.toast({ html: 'Failed to delete comment!' });
        }
    }

    function reloadComments() {
        if (this.readyState == 4) {
            if (this.status == 200) {
                let response = JSON.parse(this.responseText);
                renderComments(response.comments);
                response.messages.forEach(function(message) {
                    M.toast({ html: message });
                });
            }
        }
    }

    function renderComments(comments) {
        let count = comments.length;
        $('#comment-count').text(count + ' comments.');
        $('#comments-content').html('');
        comments.forEach(function (comment, index) {
            $('#comments-content').append('<div class="divider"></div>');
            $('#comments-content').append('<p>By ' + comment.username + ' at ' + comment.time + '</p>');
            let commentContent = '';
            comment.comment.split('\n').forEach(function(line) {
                commentContent += '<p>' + line + '</p>';
            });
            $('#comments-content').append('<blockquote>' + commentContent + '</blockquote>');
            if (comment.delete == true) {
                let deleteForm = '<form action="{{ url_for('delete_comment', urn=urn) }}" method="POST" class="delete-comment">';
                deleteForm += '<input type="hidden" name="comment-index" value="' + index + '">';
                deleteForm += '<div class="delete-wrapper">';
                deleteForm += '<button class="btn waves-effect waves-light red small right" type="submit"><i class="material-icons left">delete</i>Delete Comment</button>';
                deleteForm += '</div>';
                deleteForm += '</form>';
                $('#comments-content').append(deleteForm);
            }
        });
        $('.delete-comment').on('submit', function(e) {
            e.preventDefault();
            $('.delete-comment .btn[type=submit]').addClass('disabled')
            jsonPost($(this).attr('action'), {'comment-index': $(this).find('input[name="comment-index"]').val()}, deleteComment);
        });
        $('#comments-content').append('<div class="divider"></div>');
    }

    function updateFavourite() {
        if (this.readyState == 4) {
            if (this.status == 200) {
                let response = JSON.parse(this.responseText);
                if (response.favourite === true) {
                    $('#fav-btn i').text('favorite');
                    M.toast({ html: '<i class="material-icons left">favorite</i> Recipe added to favorites!' });
                }else if (response.favourite === false) {
                    $('#fav-btn i').text('favorite_border');
                    M.toast({ html: 'Recipe removed from favourites.' });
                }
            }else M.toast({ html: 'Oops. Something went wrong.' });
        }
    }

    function updateFeature() {
        if (this.readyState == 4) {
            if (this.status == 200) {
                let response = JSON.parse(this.responseText);
                if (response.feature === true) {
                    $('#feature-btn i').text('star');
                    M.toast({ html: '<i class="material-icons left">star</i> Recipe featured!' });
                }else if (response.feature === false) {
                    $('#feature-btn i').text('star_border');
                    M.toast({ html: 'Recipe removed from features.' });
                }
            }else M.toast({ html: 'Oops. Something went wrong.' });
        }
    }

    $(function() {
        M.Tooltip.init($('.tooltipped'));

        $('#fav-btn').on('click', function(e) {
            e.preventDefault();
            jsonGet($(this).attr('href'), updateFavourite);
        });
        $('#feature-btn').on('click', function(e) {
            e.preventDefault();
            jsonGet($(this).attr('href'), updateFeature);
        });
        $('#add-comment').on('submit', function(e) {
            e.preventDefault();
            jsonPost($(this).attr('action'), {comment: $('#comment').val()}, reloadComments);
            $('#comment').val('');
        });
        $('.delete-comment').on('submit', function(e) {
            e.preventDefault();
            $('.delete-comment .btn[type=submit]').addClass('disabled')
            jsonPost($(this).attr('action'), {'comment-index': $(this).find('input[name="comment-index"]').val()}, deleteComment);
        });
    });


</script>
{% endblock %}